{% extends "base.html" %}

{% set active_page = 'dashboard' %}

{% block title %}Smart Bus Admin Panel - Dashboard{% endblock %}

{% block header_title %}{{ org_name }} • Dashboard{% endblock %}

{% block content %}
<section id="page-dashboard" class="page-section active">
    <div class="cards-row">
        <div class="card">
            <div class="stat-card-title">Total Students</div>
            <div class="stat-card-value">{{ total_students }}</div>
        </div>
        <div class="card">
            <div class="stat-card-title">Active Buses</div>
            <div class="stat-card-value">{{ active_buses }}</div>
        </div>
        <div class="card">
            <div class="stat-card-title">Drivers</div>
            <div class="stat-card-value">{{ total_drivers }}</div>
        </div>
        <div class="card">
            <div class="stat-card-title">Today Present</div>
            <div class="stat-card-value">{{ present_today }}</div>
        </div>
    </div>

    <div class="split-row">
        <div class="card">
            <div class="card-title-row">
                <h3>Live Trips</h3><span class="muted">Updated just now</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Bus</th>
                            <th>Route</th>
                            <th>Status</th>
                            <th>Students On Board</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bus in buses %}
                        <tr>
                            <td>Bus {{ bus.bus_number }} • <span style="color:var(--text-light); font-size:0.9em;">{{
                                    bus.registration_no }}</span></td>
                            <td>{{ bus.route_name }}</td>
                            <td>
                                {% if bus.trip_status == 'in_progress' %}
                                <span class="badge badge-success" style="color:var(--success);background:#dcfce7;">In
                                    Progress</span>
                                {% elif bus.trip_status == 'completed' %}
                                <span class="badge badge-idle"
                                    style="color:#d97706;background:#fef3c7;">Completed</span>
                                {% else %}
                                <span class="badge badge-idle"
                                    style="color:var(--text-light);background:var(--bg-light);">{{
                                    bus.trip_status or 'Not Started' }}</span>
                                {% endif %}
                            </td>
                            <td style="text-align:center;">{{ bus.on_board_count or 0 }} / {{
                                bus.capacity or '-' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center; padding:15px; color:var(--text-light);">No
                                active trips found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" style="display:flex;flex-direction:column;">
            <div class="card-title-row">
                <h3>Live Bus Tracking (Preview)</h3>
            </div>
            <div id="map"></div>
            <div class="legend"><span><span class="dot" style="background:#16a34a"></span>Moving</span><span><span
                        class="dot" style="background:#f97316"></span>Idle</span><span><span class="dot"
                        style="background:#ef4444"></span>Offline</span></div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    function updateLiveTrips() {
        const updateSpan = document.querySelector('.card-title-row .muted');
        if (updateSpan) updateSpan.innerText = 'Updating...';

        fetch("{{ url_for('api.api_live_trips') }}")
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tbody = document.querySelector('.table-wrapper table tbody');
                    tbody.innerHTML = ''; // Clear current rows

                    if (data.buses.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:15px; color:var(--text-light);">No active trips found.</td></tr>`;
                    } else {
                        data.buses.forEach(bus => {
                            let statusBadge = '';
                            if (bus.trip_status === 'in_progress' || bus.trip_status === 'tripstarted') {
                                statusBadge = `<span class="badge badge-success" style="color:var(--success);background:#dcfce7;">In Progress</span>`;
                            } else if (bus.trip_status === 'completed') {
                                statusBadge = `<span class="badge badge-idle" style="color:#d97706;background:#fef3c7;">Completed</span>`;
                            } else {
                                statusBadge = `<span class="badge badge-idle" style="color:var(--text-light);background:var(--bg-light);">${bus.trip_status || 'Not Started'}</span>`;
                            }

                            const row = `
                                <tr>
                                    <td>Bus ${bus.bus_number} • <span style="color:var(--text-light); font-size:0.9em;">${bus.registration_no}</span></td>
                                    <td>${bus.route_name}</td>
                                    <td>${statusBadge}</td>
                                    <td style="text-align:center;">${bus.on_board_count} / ${bus.capacity}</td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    }
                    if (updateSpan) updateSpan.innerText = 'Updated just now';
                }
            })
            .catch(err => {
                console.error('Error fetching live trips:', err);
                if (updateSpan) updateSpan.innerText = 'Update failed';
            });
    }

    // Poll every 5 seconds
    setInterval(updateLiveTrips, 5000);
</script>
{% endblock %}