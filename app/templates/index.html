{% extends "base.html" %}

{% set active_page = 'dashboard' %}

{% block title %}Smart Bus Admin Panel - Dashboard{% endblock %}

{% block header_title %}{{ org_name }} ‚Ä¢ Dashboard{% endblock %}

{% block content %}
<section id="page-dashboard" class="page-section active">


    <!-- Top Stats Row -->
    <div class="dashboard-grid">
        <a href="{{ url_for('students.students') }}" class="stat-card card-students">
            <div class="stat-icon">üéì</div>
            <div>
                <div class="stat-value">{{ total_students }}</div>
                <div class="stat-label">Total Students</div>
            </div>
        </a>
        <a href="{{ url_for('buses.buses') }}" class="stat-card card-buses">
            <div class="stat-icon">üöå</div>
            <div>
                <div class="stat-value">{{ active_buses }}</div>
                <div class="stat-label">Active Buses</div>
            </div>
        </a>
        <a href="{{ url_for('drivers.drivers') }}" class="stat-card card-drivers">
            <div class="stat-icon">üßë‚Äç‚úàÔ∏è</div>
            <div>
                <div class="stat-value">{{ total_drivers }}</div>
                <div class="stat-label">Drivers</div>
            </div>
        </a>
        <!-- Optional 4th Card placeholder -->
        <!-- <div class="stat-card card-attendance">
            <div class="stat-icon">üìä</div>
            <div>
                <div class="stat-value">92%</div>
                <div class="stat-label">Attendance</div>
            </div>
        </div> -->
    </div>

    <!-- Main Content Grid -->
    <div class="dashboard-content">
        <!-- Live Trips Column -->
        <div class="dashboard-card">
            <div class="dashboard-header">
                <h3>Live Trips</h3>
                <span class="badge muted">Updated just now</span>
            </div>
            <div class="table-wrapper">
                <table class="premium-table">
                    <thead>
                        <tr>
                            <th>Bus Info</th>
                            <th>Route</th>
                            <th>Status</th>
                            <th style="text-align:center;">On Board</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bus in buses %}
                        <tr style="cursor: pointer;" data-url="{{ url_for('buses.bus_details', bus_id=bus.id) }}"
                            onclick="window.location.href=this.dataset.url;">
                            <td>
                                <div style="font-weight: 600; color: var(--text-primary);">Bus {{ bus.bus_number }}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">{{ bus.registration_no }}
                                </div>
                            </td>
                            <td>{{ bus.route_name }}</td>
                            <td>
                                {% if bus.trip_status == 'in_progress' %}
                                <span class="badge badge-success">In Progress</span>
                                {% elif bus.trip_status == 'completed' %}
                                <span class="badge badge-warning">Completed</span>
                                {% else %}
                                <span class="badge badge-neutral">{{ bus.trip_status or 'Not Started' }}</span>
                                {% endif %}
                            </td>
                            <td style="text-align:center; font-weight: 600;">
                                {{ bus.on_board_count or 0 }} <span style="color:var(--text-muted); font-weight:400;">/
                                    {{
                                    bus.capacity or '-' }}</span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center; padding:32px; color:var(--text-muted);">
                                <div style="font-size: 2rem; margin-bottom: 8px;">üì≠</div>
                                No active trips found at the moment.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Live Map Column -->
        <div class="dashboard-card" style="display:flex; flex-direction:column;">
            <div class="dashboard-header">
                <h3>Live Tracking</h3>
                <span class="badge">Preview</span>
            </div>
            <div style="flex-grow:1; position:relative; min-height: 300px;">
                <div id="map"></div>
                <!-- Floating Legend Overlay or Below -->
                <div class="map-legend">
                    <div class="legend-item"><span class="dot" style="background:#16a34a"></span>Moving</div>
                    <div class="legend-item"><span class="dot" style="background:#f97316"></span>Idle</div>
                    <div class="legend-item"><span class="dot" style="background:#ef4444"></span>Offline</div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const busDetailsBaseUrl = "{{ url_for('buses.bus_details', bus_id='BUS_ID_PH') }}";

    function updateLiveTrips() {
        const updateSpan = document.querySelector('.dashboard-header .badge.muted');
        if (updateSpan) updateSpan.innerText = 'Updating...';

        fetch("{{ url_for('api.api_live_trips') }}")
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tbody = document.querySelector('.table-wrapper table tbody');
                    tbody.innerHTML = '';

                    if (data.buses.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:32px; color:var(--text-muted);"><div style="font-size: 2rem; margin-bottom: 8px;">üì≠</div>No active trips found at the moment.</td></tr>`;
                    } else {
                        data.buses.forEach(bus => {
                            let statusBadge = '';
                            if (bus.trip_status === 'in_progress' || bus.trip_status === 'tripstarted') {
                                statusBadge = `<span class="badge badge-success">In Progress</span>`;
                            } else if (bus.trip_status === 'completed') {
                                statusBadge = `<span class="badge badge-warning">Completed</span>`;
                            } else {
                                statusBadge = `<span class="badge badge-neutral">${bus.trip_status || 'Not Started'}</span>`;
                            }

                            const link = busDetailsBaseUrl.replace('BUS_ID_PH', bus.id);

                            const row = `
                                <tr style="cursor: pointer;" onclick="window.location.href='${link}'">
                                    <td>
                                        <div style="font-weight: 600; color: var(--text-primary);">Bus ${bus.bus_number}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">${bus.registration_no}</div>
                                    </td>
                                    <td>${bus.route_name}</td>
                                    <td>${statusBadge}</td>
                                    <td style="text-align:center; font-weight: 600;">
                                        ${bus.on_board_count || 0} <span style="color:var(--text-muted); font-weight:400;">/ ${bus.capacity || '-'}</span>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    }
                    if (updateSpan) updateSpan.innerText = 'Updated just now';
                }
            })
            .catch(err => {
                console.error('Error fetching live trips:', err);
                if (updateSpan) updateSpan.innerText = 'Update failed';
            });
    }

    // Poll every 5 seconds
    setInterval(updateLiveTrips, 5000);

    // Live Map Logic
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('map')) {
            const map = L.map('map').setView([12.096, 75.558], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const markers = {};
            const uid = "{{ session['uid'] }}";
            const locationRef = rtdb.ref(`organizations/${uid}/bus_location`);

            locationRef.on('value', (snapshot) => {
                const buses = snapshot.val();
                console.log("[DEBUG Dashboard] Received buses data:", buses);

                if (buses) {
                    Object.keys(buses).forEach(busId => {
                        const data = buses[busId];
                        if (data && data.latitude != null && data.longitude != null) {
                            const lat = parseFloat(data.latitude);
                            const lng = parseFloat(data.longitude);

                            if (isNaN(lat) || isNaN(lng)) return;

                            if (markers[busId]) {
                                markers[busId].setLatLng([lat, lng]);
                                markers[busId].setPopupContent(`<b>Bus ${data.bus_number || 'Unknown'}</b><br>Speed: ${data.speed || 0} km/h`);
                            } else {
                                markers[busId] = L.marker([lat, lng]).addTo(map)
                                    .bindPopup(`<b>Bus ${data.bus_number || 'Unknown'}</b><br>Speed: ${data.speed || 0} km/h`);
                            }
                        }
                    });
                }
            });
        }
    });
</script>
{% endblock %}