{% extends "base.html" %}

{% set active_page = 'buses' %}

{% block title %}Smart Bus Admin Panel - Add Bus{% endblock %}

{% block header_title %}Smart Bus Admin â€¢ Add Bus{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div class="card">
        <div class="card-title-row" style="margin-bottom: 20px;">
            <h3>Add New Bus</h3>
        </div>
        <form id="addBusForm">
            <div class="split-row" style="margin-top:0; margin-bottom:16px; gap:12px">
                <div>
                    <label class="form-label">Bus Number</label>
                    <input type="text" id="bus_number" class="form-input" placeholder="e.g. Bus 1" required>
                </div>
                <div>
                    <label class="form-label">Registration No</label>
                    <input type="text" id="registration_no" class="form-input" placeholder="e.g. KL-10-..." required>
                </div>
            </div>
            <div class="split-row" style="margin-top:0; margin-bottom:16px; gap:12px">
                <div>
                    <label class="form-label">Capacity</label>
                    <input type="number" id="capacity" class="form-input" placeholder="Number of seats" required>
                </div>
                <div>
                    <label class="form-label">Model</label>
                    <input type="text" id="model" class="form-input" placeholder="Bus Model">
                </div>
            </div>
            <div class="split-row" style="margin-top:0; margin-bottom:16px; gap:12px">
                <div>
                    <label class="form-label">On Board Count (Initial)</label>
                    <input type="number" id="on_board_count" class="form-input" placeholder="0" value="0">
                </div>
                <div style="flex-grow:1"></div> <!-- Spacer -->
            </div>
            <div class="form-group">
                <label class="form-label">Assign Driver</label>
                <select id="driver_name" class="form-input">
                    <option value="">Select Driver...</option>
                    {% for driver in drivers %}
                    <option value="{{ driver.id }}" data-name="{{ driver.full_name }}">{{
                        driver.full_name }}</option>
                    {% endfor %}
                    <option value="Unassigned">Unassigned</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Assign Route</label>
                <select id="route" class="form-input">
                    <option value="">Select Route...</option>
                    {% for route in routes %}
                    <option value="{{ route.route_name }}" data-id="{{ route.id }}">{{ route.route_name
                        }}</option>
                    {% endfor %}
                    <option value="N/A">N/A</option>
                </select>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <h4 style="margin-bottom: 15px; font-size: 1rem; color: var(--text-dark);">Service &
                    Compliance</h4>
                <div class="split-row" style="margin-top:0; margin-bottom:16px; gap:12px">
                    <div>
                        <label class="form-label">Last Service Date</label>
                        <input type="date" id="last_service_date" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Next Service Due</label>
                        <input type="date" id="next_service_due" class="form-input">
                    </div>
                </div>
                <div class="split-row" style="margin-top:0; margin-bottom:16px; gap:12px">
                    <div>
                        <label class="form-label">Insurance Expiry</label>
                        <input type="date" id="insurance_expiry" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Fitness Cert. Expiry</label>
                        <input type="date" id="fitness_expiry" class="form-input">
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <a href="{{ url_for('buses.buses') }}" class="btn"
                    style="background:#f3f4f6; color:#374151; text-decoration: none;">Cancel</a>
                <button type="submit" class="btn btn-primary">Save Bus</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('addBusForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const driverSelect = document.getElementById('driver_name');
        const selectedOption = driverSelect.options[driverSelect.selectedIndex];
        const driverId = driverSelect.value;
        const driverName = selectedOption.getAttribute('data-name') || (driverId === 'Unassigned' ? 'Unassigned' : selectedOption.innerText);

        const formData = {
            bus_number: document.getElementById('bus_number').value,
            registration_no: document.getElementById('registration_no').value,
            capacity: document.getElementById('capacity').value,
            model: document.getElementById('model').value,
            on_board_count: document.getElementById('on_board_count').value || 0,
            driver_name: driverName,
            driver_id: driverId === 'Unassigned' ? null : driverId,
            route: document.getElementById('route').value || 'N/A',
            route_id: document.getElementById('route').options[document.getElementById('route').selectedIndex].getAttribute('data-id') || '',
            last_service_date: document.getElementById('last_service_date').value,
            next_service_due: document.getElementById('next_service_due').value,
            insurance_expiry: document.getElementById('insurance_expiry').value,
            fitness_expiry: document.getElementById('fitness_expiry').value
        };

        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Saving...';

        fetch("{{ url_for('api.api_add_bus') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Bus Added Successfully!');
                    window.location.href = "{{ url_for('buses.buses') }}";
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerText = originalText;
            });
    });
</script>
{% endblock %}