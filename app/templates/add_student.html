{% extends "base.html" %}

{% set active_page = 'add_student' %}

{% block title %}Smart Bus Admin Panel - Add Student{% endblock %}

{% block content %}
<section class="section">
    <div class="section-header">
        <h1 class="page-title">Add New Student</h1>
    </div>

    <div class="card form-container">
        <form id="addStudentForm" class="form-grid">
            <!-- Student ID (Hidden or Readonly) -->
            <!-- We will generate this via API before submitting -->

            <h4 class="form-section-title">Student Details</h4>

            <div class="split-row">
                <div>
                    <label class="form-label">Full Name</label>
                    <input type="text" id="full_name" class="form-input" placeholder="e.g. John Doe" required>
                </div>
                <div>
                    <label class="form-label">Date of Birth</label>
                    <input type="date" id="dob" class="form-input" required>
                </div>
            </div>

            <div class="split-row">
                <div>
                    <label class="form-label">Email Address (Optional)</label>
                    <input type="email" id="email" class="form-input" placeholder="student@school.com">
                </div>
                <div>
                    <label class="form-label">Roll Number</label>
                    <input type="text" id="roll_number" class="form-input" placeholder="e.g. 2023-001" required>
                </div>
            </div>

            <div class="split-row">
                <div>
                    <label class="form-label">Batch / Class</label>
                    <input type="text" id="batch" class="form-input" placeholder="e.g. Class 10-A" required>
                </div>
                <div>
                    <label class="form-label">Student Phone (Optional)</label>
                    <input type="tel" id="student_phone" class="form-input" placeholder="10-digit number">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Address</label>
                <textarea id="address" class="form-input" rows="3" placeholder="Full Address" required></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Profile Photo</label>
                <input type="file" id="student_photo" class="form-input" accept="image/*">
            </div>

            <!-- Transport Details -->
            <h4 class="form-section-title">Transport Details</h4>

            <div class="split-row">
                <div>
                    <label class="form-label">Select Bus</label>
                    <select id="bus_select" class="form-input" onchange="updateStops()">
                        <option value="">Select Bus...</option>
                        {% for bus in buses %}
                        <option value="{{ bus.bus_number }}">{{ bus.bus_number }} - {{ bus.route }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="form-label">Select Stop</label>
                    <select id="bus_stop" class="form-input" onchange="updateFee()">
                        <option value="">Select Bus First...</option>
                    </select>
                </div>
            </div>

            <!-- Fee Details -->
            <h4 class="form-section-title">Fee Details</h4>

            <div class="split-row">
                <div>
                    <label class="form-label">Payment Type</label>
                    <input type="text" id="payment_type" class="form-input" value="{{ payment_type }}" readonly>
                </div>
                <div>
                    <label class="form-label">Fee Amount (â‚¹)</label>
                    <input type="number" id="fee_amount" class="form-input" placeholder="0" required min="0">
                </div>
            </div>

            <h4 class="form-section-title">Parent Details</h4>

            <div class="split-row">
                <div>
                    <label class="form-label">Parent Name</label>
                    <input type="text" id="parent_name" class="form-input" placeholder="e.g. Jane Doe" required>
                </div>
                <div>
                    <label class="form-label">Parent Phone</label>
                    <input type="tel" id="parent_phone" class="form-input" placeholder="10-digit number" required>
                </div>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('students.students') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save Student</button>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block scripts %}

<script id="buses-data" type="application/json">{{ buses | tojson }}</script>
<script id="routes-data" type="application/json">{{ routes | tojson }}</script>

<script>
    const busesData = JSON.parse(document.getElementById('buses-data').textContent);
    const routesData = JSON.parse(document.getElementById('routes-data').textContent);

    document.getElementById('addStudentForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        const rollNumber = document.getElementById('roll_number').value;

        if (!rollNumber) {
            alert("Please enter a roll number first.");
            return;
        }

        // 1. Get New Student ID First
        fetch("{{ url_for('api.api_generate_student_id') }}")
            .then(r => r.json())
            .then(idData => {
                if (idData.status !== 'success') throw new Error(idData.message);
                const studentId = idData.student_id;

                // UI State: Waiting for RFID
                btn.disabled = true;
                btn.innerText = 'Scan RFID Card Now...';

                // 2. Initiate RFID Write with Student ID and Roll Number
                return fetch("{{ url_for('api.api_rfid_initiate') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, roll_number: rollNumber })
                })
                    .then(res => res.json())
                    .then(initData => {
                        if (initData.status !== 'success') {
                            throw new Error(initData.message || 'Failed to initiate RFID write');
                        }

                        // 3. Poll for Status
                        let attempts = 0;
                        const maxAttempts = 30; // 30 seconds

                        const pollInterval = setInterval(() => {
                            attempts++;
                            if (attempts > maxAttempts) {
                                clearInterval(pollInterval);
                                alert("RFID Write Timed Out. Please try again.");
                                btn.disabled = false;
                                btn.innerText = originalText;
                                return;
                            }

                            fetch("{{ url_for('api.api_rfid_status') }}")
                                .then(r => r.json())
                                .then(statusData => {
                                    console.log("RFID Status:", statusData);
                                    // Check if status is success and the ID matched matches what we sent (Roll Number)
                                    // api_rfid_initiate now puts rollNumber into the 'student_id' field of RTDB
                                    if (statusData.status === 'success' && statusData.student_id === rollNumber) {
                                        clearInterval(pollInterval);
                                        btn.innerText = 'Saving Student...';

                                        // Pass the generated ID to submit function (This is the DOC ID)
                                        submitStudentData(btn, originalText, studentId);
                                    } else if (statusData.status === 'error') {
                                        clearInterval(pollInterval);
                                        alert("RFID Write Failed: " + (statusData.message || "Unknown error"));
                                        btn.disabled = false;
                                        btn.innerText = originalText;
                                    }
                                })
                                .catch(err => console.error("Polling error:", err));
                        }, 1000);
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerText = originalText;
            });
    });

    function updateStops() {
        const busSelect = document.getElementById('bus_select');
        const stopSelect = document.getElementById('bus_stop');
        const busNumber = busSelect.value;
        // Reset
        stopSelect.innerHTML = '<option value="">Select Stop...</option>';
        document.getElementById('fee_amount').value = '';

        if (!busNumber) return;

        // Find bus
        const selectedBus = busesData.find(b => b.bus_number === busNumber);
        if (!selectedBus || !selectedBus.route) {
            const opt = document.createElement('option');
            opt.innerText = "No route assigned to this bus";
            stopSelect.appendChild(opt);
            return;
        }

        // Find route
        const selectedRoute = routesData.find(r => r.route_name === selectedBus.route);
        if (selectedRoute) {
            let stops = selectedRoute.stops || [];
            if (typeof stops === 'string') {
                stops = stops.split(',').map(s => s.trim());
            }

            if (Array.isArray(stops)) {
                stops.forEach(stop => {
                    const opt = document.createElement('option');
                    // Check if stop is an object (new format) or string (old format)
                    let stopName = stop;
                    let stopFee = 0;

                    if (typeof stop === 'object') {
                        stopName = stop.name || '';
                        stopFee = stop.fee || 0;
                    }

                    opt.value = stopName;
                    opt.innerText = stopName;
                    opt.setAttribute('data-fee', stopFee);
                    stopSelect.appendChild(opt);
                });
            }
        }
    }

    function updateFee() {
        const stopSelect = document.getElementById('bus_stop');
        const feeInput = document.getElementById('fee_amount');

        const selectedOption = stopSelect.options[stopSelect.selectedIndex];
        if (selectedOption) {
            const fee = selectedOption.getAttribute('data-fee');
            if (fee) {
                feeInput.value = fee;
            }
        }
    }

    function submitStudentData(btn, originalText, studentId) {
        const formData = new FormData();
        if (studentId) formData.append('student_id', studentId);
        formData.append('full_name', document.getElementById('full_name').value);
        formData.append('dob', document.getElementById('dob').value);
        formData.append('email', document.getElementById('email').value);
        formData.append('roll_number', document.getElementById('roll_number').value);
        formData.append('batch', document.getElementById('batch').value);
        formData.append('student_phone', document.getElementById('student_phone').value);
        formData.append('address', document.getElementById('address').value);

        // Transport Details
        formData.append('bus_number', document.getElementById('bus_select').value);
        formData.append('bus_stop', document.getElementById('bus_stop').value);

        formData.append('parent_name', document.getElementById('parent_name').value);
        formData.append('parent_phone', document.getElementById('parent_phone').value);
        formData.append('fee_amount', document.getElementById('fee_amount').value);
        formData.append('payment_type', document.getElementById('payment_type').value);

        const fileInput = document.getElementById('student_photo');
        if (fileInput && fileInput.files.length > 0) {
            formData.append('student_photo', fileInput.files[0]);
        }

        fetch("{{ url_for('api.api_add_student') }}", {
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Student Added Successfully!');
                    window.location.href = "{{ url_for('students.students') }}";
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerText = originalText;
            });
    }
</script>
{% endblock %}