{% extends "base.html" %}

{% set active_page = 'drivers' %}

{% block title %}Smart Bus Admin Panel - Driver Details{% endblock %}

{% block header_title %}Smart Bus Admin â€¢ Driver Details{% endblock %}

{% block content %}
<div class="detail-layout">

    <!-- LEFT COLUMN: Profile Summary -->
    <div class="profile-sidebar">
        <div class="card">
            <div class="profile-avatar-large">
                {% if driver.profile_photo_url %}
                <img src="{{ driver.profile_photo_url }}" alt="Profile">
                {% else %}
                {{ driver.full_name[0] if driver.full_name else '?' }}
                {% endif %}
            </div>

            <div id="edit_photo_container" style="display:none; margin-bottom: 10px;">
                <label for="edit_driver_photo" class="btn btn-secondary"
                    style="font-size:0.8rem; padding:4px 8px;">Change Photo</label>
                <input type="file" id="edit_driver_photo" style="display: none;" accept="image/*">
            </div>

            <h2 class="profile-name">
                <span id="display_full_name">{{ driver.full_name }}</span>
                <input type="text" id="edit_full_name" class="form-input-edit" value="{{ driver.full_name }}"
                    style="display:none;">
            </h2>

            <div class="profile-meta">
                <div>License: <span id="display_license_number" style="font-family:monospace">{{ driver.license_number
                        }}</span>

                </div>
            </div>

            <div class="badge badge-success" style="font-size: 0.9rem; padding: 6px 16px;">Active Driver</div>

            <div style="margin-top: 24px;">
                <button id="edit-profile-btn" class="btn btn-primary" style="width:100%; justify-content:center;">
                    Edit Profile
                </button>
            </div>

            <div style="margin-top: 12px;">
                <button onclick="deleteDriver()" class="btn btn-danger" style="width:100%; justify-content:center;">
                    Delete Driver
                </button>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN: Details -->
    <div class="main-content">

        <!-- Details Card -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="section-title">Driver Details</div>

            <div class="detail-grid">
                <!-- Personal Info -->
                <div class="info-group">
                    <label class="info-label">Phone Number</label>
                    <div class="value" id="display_phone_number">{{ driver.phone_number }}</div>
                    <input type="tel" id="edit_phone_number" class="form-input-edit" value="{{ driver.phone_number }}"
                        style="display:none; opacity:0.6; cursor:not-allowed" disabled
                        title="Phone number cannot be changed as it is linked to the login account.">
                </div>
                <div class="info-group">
                    <label class="info-label">Date of Birth</label>
                    <div class="value" id="display_date_of_birth">{{ driver.date_of_birth or 'N/A' }}</div>
                    <input type="date" id="edit_date_of_birth" class="form-input-edit"
                        value="{{ driver.date_of_birth }}" style="display:none;">
                </div>
                <div class="info-group">
                    <label class="info-label">Blood Group</label>
                    <div class="value" id="display_blood_group">{{ driver.blood_group or 'N/A' }}</div>
                    <select id="edit_blood_group" class="form-input-edit" style="display:none;">
                        <option value="">Select...</option>
                        <option value="A+" {% if driver.blood_group=='A+' %}selected{% endif %}>A+</option>
                        <option value="A-" {% if driver.blood_group=='A-' %}selected{% endif %}>A-</option>
                        <option value="B+" {% if driver.blood_group=='B+' %}selected{% endif %}>B+</option>
                        <option value="B-" {% if driver.blood_group=='B-' %}selected{% endif %}>B-</option>
                        <option value="O+" {% if driver.blood_group=='O+' %}selected{% endif %}>O+</option>
                        <option value="O-" {% if driver.blood_group=='O-' %}selected{% endif %}>O-</option>
                        <option value="AB+" {% if driver.blood_group=='AB+' %}selected{% endif %}>AB+</option>
                        <option value="AB-" {% if driver.blood_group=='AB-' %}selected{% endif %}>AB-</option>
                    </select>
                </div>
                <div class="info-group" style="grid-column: 1 / -1">
                    <label class="info-label">Address</label>
                    <div class="value" id="display_address">{{ driver.address or 'N/A' }}</div>
                    <textarea id="edit_address" class="form-input-edit"
                        style="display:none;">{{ driver.address }}</textarea>
                </div>
            </div>

            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--glass-border);">
                <h4
                    style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:12px; text-transform:uppercase;">
                    Professional & Assignment
                </h4>
                <div class="detail-grid">
                    <div class="info-group">
                        <label class="info-label">Assigned Bus</label>
                        <div class="value" id="display_assigned_bus">
                            {% if driver.assigned_bus_name %}
                            {{ driver.assigned_bus_name }}
                            {% else %}
                            Unassigned
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Add Stop Permission</label>
                        <div style="display: flex; align-items: center; gap: 8px; padding-top: 4px;">
                            <label class="switch">
                                <input type="checkbox" id="live_can_add_stop"
                                    onchange="updateField('can_add_stop', this.checked)" {% if driver.can_add_stop
                                    %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                            <span id="can_add_stop_label" style="font-size: 0.9rem; color: var(--text-secondary);">
                                {% if driver.can_add_stop %}Enabled{% else %}Disabled{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Joining Date</label>
                        <div class="value" id="display_joining_date">{{ driver.joining_date or 'N/A' }}</div>

                    </div>
                    <div class="info-group">
                        <label class="info-label">License Expiry</label>
                        <div class="value" id="display_license_expiry_date">{{ driver.license_expiry_date or 'N/A' }}
                        </div>
                        <input type="date" id="edit_license_expiry_date" class="form-input-edit"
                            value="{{ driver.license_expiry_date }}" style="display:none;">
                    </div>
                    <div class="info-group">
                        <label class="info-label">Emergency Contact</label>
                        <div class="value" id="display_emergency_contact">
                            {{ driver.emergency_contact_name or 'N/A' }}
                            {% if driver.emergency_contact_phone %}
                            <br><span style="font-size:0.9rem;color:var(--text-secondary)">{{
                                driver.emergency_contact_phone }}</span>
                            {% endif %}
                        </div>
                        <div id="edit_emergency_contact" style="display:none;">
                            <input type="text" id="edit_emergency_contact_name" class="form-input-edit"
                                value="{{ driver.emergency_contact_name }}" placeholder="Name"
                                style="margin-bottom:5px;">
                            <input type="tel" id="edit_emergency_contact_phone" class="form-input-edit"
                                value="{{ driver.emergency_contact_phone }}" placeholder="Phone">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip History -->
        <div class="card">
            <div class="section-title">Trip History</div>
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Bus No</th>
                            <th>Trip Type</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trip in trip_history %}
                        <tr>
                            <td>{{ trip.date }}</td>
                            <td>{{ trip.bus_number }}</td>
                            <td><span class="badge badge-secondary">{{ trip.type|capitalize }}</span></td>
                            <td>{{ trip.startTime[11:16] if trip.startTime|length > 16 else trip.startTime }}</td>
                            <td>{{ trip.endTime[11:16] if trip.endTime and trip.endTime|length > 16 else (trip.endTime
                                or '-') }}</td>
                            <td>{{ trip.durationMinutes }} min</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" style="text-align:center; padding: 20px; color: var(--text-muted);">No trip
                                history found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isEditing = false;
    const editBtn = document.querySelector('.btn-primary');

    editBtn.addEventListener('click', function () {
        if (!isEditing) {
            // Switch to Edit Mode
            isEditing = true;
            this.innerHTML = '<span style="font-size:1rem; margin-right:6px">ðŸ’¾</span> Save Changes';
            this.style.backgroundColor = '#10b981'; // Green color

            // Toggle visibility
            toggleFields(true);
        } else {
            // Save Changes
            saveChanges();
        }
    });

    function toggleFields(showInput) {
        const fields = [
            'full_name', 'license_number', 'phone_number', 'address',
            'date_of_birth', 'blood_group',
            'joining_date', 'license_expiry_date'
        ];

        fields.forEach(field => {
            const displayEl = document.getElementById('display_' + field);
            const inputEl = document.getElementById('edit_' + field);
            if (displayEl && inputEl) {
                displayEl.style.display = showInput ? 'none' : 'block';
                inputEl.style.display = showInput ? 'block' : 'none';
            }
        });

        // Special handling for Emergency Contact
        document.getElementById('display_emergency_contact').style.display = showInput ? 'none' : 'block';
        document.getElementById('edit_emergency_contact').style.display = showInput ? 'block' : 'none';

        // Photo Edit
        const photoContainer = document.getElementById('edit_photo_container');
        if (photoContainer) photoContainer.style.display = showInput ? 'block' : 'none';
    }

    function saveChanges() {
        const btn = document.querySelector('.btn-primary');
        const originalText = '<span style="font-size:1rem; margin-right:6px">âœŽ</span> Edit Profile';
        btn.innerText = 'Saving...';
        btn.disabled = true;

        const formData = new FormData();
        formData.append('full_name', document.getElementById('edit_full_name').value);
        formData.append('license_number', document.getElementById('edit_license_number').value);
        formData.append('phone_number', document.getElementById('edit_phone_number').value);
        formData.append('address', document.getElementById('edit_address').value);
        formData.append('date_of_birth', document.getElementById('edit_date_of_birth').value);
        formData.append('blood_group', document.getElementById('edit_blood_group').value);
        formData.append('assigned_bus', document.getElementById('edit_assigned_bus').value);
        formData.append('joining_date', document.getElementById('edit_joining_date').value);
        formData.append('license_expiry_date', document.getElementById('edit_license_expiry_date').value);
        formData.append('emergency_contact_name', document.getElementById('edit_emergency_contact_name').value);
        formData.append('emergency_contact_phone', document.getElementById('edit_emergency_contact_phone').value);
        formData.append('can_add_stop', document.getElementById('input_can_add_stop').checked);

        const fileInput = document.getElementById('edit_driver_photo');
        if (fileInput && fileInput.files.length > 0) {
            formData.append('driver_photo', fileInput.files[0]);
        }

        fetch("{{ url_for('api.api_update_driver', driver_id=driver.id) }}", {
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Driver details updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = ''; // Reset color
                    isEditing = false;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.backgroundColor = ''; // Reset color
                isEditing = false;
            });
    }

    function deleteDriver() {
        if (confirm('Are you sure you want to delete this driver? This action cannot be undone.')) {
            fetch("{{ url_for('api.api_delete_driver', driver_id=driver.id) }}", {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Driver deleted successfully.');
                        window.location.href = "{{ url_for('drivers.drivers') }}";
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
        }
    }

    function updateField(fieldName, value) {
        const payload = {};
        payload[fieldName] = value;

        // Optimistic UI update for label
        if (fieldName === 'can_add_stop') {
            const label = document.getElementById('can_add_stop_label');
            if (label) label.innerText = value ? 'Enabled' : 'Disabled';
        }

        fetch("{{ url_for('api.api_update_driver', driver_id=driver.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    alert('Failed to update: ' + data.message);
                    // Revert change if needed (complex for select, easy for checkbox)
                    if (fieldName === 'assigned_bus') {
                        location.reload();
                    } else if (fieldName === 'can_add_stop') {
                        document.getElementById('live_can_add_stop').checked = !value;
                        const label = document.getElementById('can_add_stop_label');
                        if (label) label.innerText = !value ? 'Enabled' : 'Disabled';
                    }
                } else {
                    // Success feedback (optional)
                    console.log(fieldName + ' updated successfully');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
</script>

<style>
    /* Switch Toggle CSS */
    .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
    }

    input:checked+.slider {
        background-color: var(--primary);
    }

    input:focus+.slider {
        box-shadow: 0 0 1px var(--primary);
    }

    input:checked+.slider:before {
        -webkit-transform: translateX(20px);
        -ms-transform: translateX(20px);
        transform: translateX(20px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 34px;
    }

    .slider.round:before {
        border-radius: 50%;
    }
</style>
{% endblock %}