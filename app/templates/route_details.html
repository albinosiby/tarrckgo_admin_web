{% extends "base.html" %}

{% set active_page = 'routes' %}

{% block title %}Smart Bus Admin Panel - Route Details{% endblock %}

{% block header_title %}Smart Bus Admin ‚Ä¢ Route Details{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="detail-layout">

    <!-- LEFT COLUMN: Route Profile -->
    <div class="profile-sidebar">
        <div class="card">
            <div class="profile-avatar-large" style="font-size: 3rem;">
                üó∫Ô∏è
            </div>

            <h2 class="profile-name">
                <span id="display_route_name">{{ route.route_name }}</span>
                <input type="text" id="edit_route_name" class="form-input-edit" value="{{ route.route_name }}"
                    style="display:none;">
            </h2>

            <div class="profile-meta">
                <span id="display_points">{{ route.start_point }} ‚ûù {{ route.end_point }}</span>
                <div id="edit_points" style="display:none; margin-top:5px;">
                    <input type="text" id="edit_start_point" class="form-input-edit" value="{{ route.start_point }}"
                        placeholder="Start Point" style="margin-bottom:5px;">
                    <input type="text" id="edit_end_point" class="form-input-edit" value="{{ route.end_point }}"
                        placeholder="End Point">
                </div>
            </div>

            <div class="badge badge-success" style="font-size: 0.9rem; padding: 6px 16px;">Active Route</div>

            <div style="margin-top: 24px;">
                <button id="edit-profile-btn" class="btn btn-primary" style="width:100%; justify-content:center;">
                    <span style="margin-right:8px">‚úèÔ∏è</span> Edit Route
                </button>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN: Details & Map -->
    <div class="main-content">

        <!-- Route Info Card -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="section-title">Route Information</div>

            <div class="detail-grid">
                <div class="info-group" style="grid-column: 1 / -1">
                    <label class="info-label">Stops</label>
                    <div class="value" id="display_stops" style="padding: 0;">
                        {% if route.stops %}
                        <div class="timeline-container">
                            {% if route.stops is string %}
                            {% for stop in route.stops.split(',') %}
                            {% if stop.strip() %}
                            <div class="timeline-item stop-tile" data-name="{{ stop.strip() }}" data-fee="0" data-id="">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <span class="t-name">{{ stop.strip() }}</span>
                                    <span class="t-fee">‚Çπ0</span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% else %}
                            {% for stop in route.stops %}
                            {% if stop is string %}
                            <div class="timeline-item stop-tile" data-name="{{ stop }}" data-fee="0" data-id="">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <span class="t-name">{{ stop }}</span>
                                    <span class="t-fee">‚Çπ0</span>
                                </div>
                            </div>
                            {% else %}
                            <div class="timeline-item stop-tile" data-name="{{ stop.name }}" data-fee="{{ stop.fee }}"
                                data-id="{{ stop.id or '' }}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <span class="t-name">{{ stop.name }}</span>
                                    <span class="t-fee">‚Çπ{{ stop.fee }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% else %}
                        <div style="padding: 10px; color: var(--text-secondary);">No stops defined</div>
                        {% endif %}
                    </div>
                    <div id="edit_stops_container" style="display:none; margin-top: 10px;">
                        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                            <select id="geo_stop_selector" class="form-input-edit" style="flex:1;">
                                <option value="">-- Select Global Stop --</option>
                                {% for stop in all_stops %}
                                <option value="{{ stop.id }}" data-name="{{ stop.stop_name }}"
                                    data-fee="{{ stop.fee }}">{{ stop.stop_name }} (‚Çπ{{ stop.fee }})</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="addSelectedStop()">Add</button>
                        </div>
                        <div id="stops_list"></div>
                    </div>
                </div>

                <div class="info-group">
                    <label class="info-label">Distance</label>
                    <div class="value" id="display_distance">{{ route.distance or 'N/A' }}</div>
                    <input type="text" id="edit_distance" class="form-input-edit" value="{{ route.distance }}"
                        style="display:none;">
                </div>

                <div class="info-group">
                    <label class="info-label">Assigned Bus</label>
                    <div class="value" id="display_assigned_bus">{{ route.assigned_bus_name or 'Unassigned' }}</div>
                    <select id="edit_assigned_bus" class="form-input-edit" style="display:none;">
                        <option value="">Select Bus...</option>
                        {% for bus in buses %}
                        <option value="{{ bus.id }}" {% if route.assigned_bus==bus.id %}selected{% endif %}>
                            {{ bus.bus_number }}
                        </option>
                        {% endfor %}
                        <option value="">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Map Card -->
        <div class="card">
            <div class="section-title">Route Map</div>
            <div id="map" style="height: 400px; border-radius: 8px; border: 1px solid var(--glass-border);"></div>
        </div>
    </div>
</div>

<style>
    .timeline-container {
        position: relative;
        padding: 10px 0;
        margin-left: 10px;
    }

    .timeline-item {
        position: relative;
        padding-left: 25px;
        padding-bottom: 20px;
        display: flex;
        align-items: center;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: 6px;
        top: 24px;
        bottom: -4px;
        width: 2px;
        background: rgba(255, 255, 255, 0.1);
    }

    .timeline-item:last-child::before {
        display: none;
    }

    .timeline-marker {
        position: absolute;
        left: 0;
        top: 4px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--primary);
        border: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
    }

    .timeline-content {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        padding: 8px 12px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }

    .timeline-item:hover .timeline-content {
        background: rgba(255, 255, 255, 0.06);
        transform: translateX(4px);
    }

    .t-name {
        font-weight: 500;
        color: var(--text-primary);
    }

    .t-fee {
        font-size: 0.85rem;
        color: var(--text-secondary);
        background: rgba(0, 0, 0, 0.2);
        padding: 2px 8px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block scripts %}
<script id="route-stops-data" type="application/json">
    {{ route.stops|tojson }}
</script>
<script id="all-stops-data" type="application/json">
    {{ all_stops|tojson }}
</script>
<script id="assigned-bus-data" type="application/json">
    {{ assigned_bus|tojson if assigned_bus else 'null' }}
</script>
<script>
    // Initialize map
    const map = L.map('map').setView([11.2588, 75.7804], 13); // Default to Calicut
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Add markers for start and end points (Placeholder coordinates)
    // In a real app, you would geocode the start and end points
    const startMarker = L.marker([11.2588, 75.7804]).addTo(map).bindPopup('Start: {{ route.start_point }}');
    const endMarker = L.marker([11.2700, 75.7900]).addTo(map).bindPopup('End: {{ route.end_point }}');

    // Consolidate Stop Rendering
    const markers = []; // For fitBounds

    try {
        const allStops = JSON.parse(document.getElementById('all-stops-data').textContent);
        const routeStops = JSON.parse(document.getElementById('route-stops-data').textContent);

        // Create a Set of Route Stop IDs for fast lookup
        const routeStopIds = new Set();
        if (Array.isArray(routeStops)) {
            routeStops.forEach(s => {
                if (s.id) routeStopIds.add(s.id);
                // Also handle cases where ID might be missing but we have coords (legacy) - tricky to match, skipping for now
            });
        }

        if (Array.isArray(allStops)) {
            allStops.forEach(stop => {
                if (stop.lat && stop.long) {
                    const lat = parseFloat(stop.lat);
                    const lng = parseFloat(stop.long);

                    if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
                        const isRouteStop = routeStopIds.has(stop.id);

                        // Style: Blue if in route, Grey if global only
                        const color = isRouteStop ? "#3b82f6" : "#808080";
                        const fillColor = isRouteStop ? "#3b82f6" : "#808080";
                        const radius = isRouteStop ? 8 : 6;
                        const fillOpacity = isRouteStop ? 0.8 : 0.6;
                        const zIndexOffset = isRouteStop ? 1000 : 0; // Bring active stops to front

                        const marker = L.circleMarker([lat, lng], {
                            radius: radius,
                            fillColor: fillColor,
                            color: "#fff",
                            weight: 2,
                            opacity: 1,
                            fillOpacity: fillOpacity
                        }).addTo(map);

                        const popupContent = isRouteStop
                            ? `<b>${stop.stop_name || 'Stop'}</b><br>Fee: ‚Çπ${stop.fee || 0}<br><span class="badge badge-success">In Route</span>`
                            : `<b>${stop.stop_name || 'Stop'}</b><br><small>Global Stop</small>`;

                        marker.bindPopup(popupContent);

                        if (isRouteStop) {
                            markers.push(marker);
                        }
                    }
                }
            });
        }
    } catch (e) { console.error("Error rendering stops", e); }

    // Live Bus Tracking
    try {
        const busDataContent = document.getElementById('assigned-bus-data').textContent;
        const assignedBusData = JSON.parse(busDataContent);

        if (assignedBusData && assignedBusData.id) {
            const uid = "{{ session['uid'] }}";
            const busId = assignedBusData.id;
            const busNo = assignedBusData.bus_number;

            // Initial static render (optional fallback) 
            // .. skipped to rely on live data

            if (uid && busId) {
                const busRef = rtdb.ref(`organizations/${uid}/bus_location/${busId}`);
                console.log(`Listening to bus location: organizations/${uid}/bus_location/${busId}`);

                let liveBusMarker = null;

                busRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.latitude != null && data.longitude != null) {
                        const lat = parseFloat(data.latitude);
                        const lng = parseFloat(data.longitude);

                        if (!isNaN(lat) && !isNaN(lng)) {
                            // Update or Create Marker
                            if (liveBusMarker) {
                                liveBusMarker.setLatLng([lat, lng]);
                                liveBusMarker.setPopupContent(`<b>Bus ${busNo}</b><br>Speed: ${data.speed || 0} km/h`);
                            } else {
                                const busIcon = L.divIcon({
                                    html: '<div style="font-size: 24px; text-align: center; line-height: 1; text-shadow: 0 0 5px rgba(0,0,0,0.5);">üöå</div>',
                                    className: 'bus-marker-icon',
                                    iconSize: [30, 30],
                                    iconAnchor: [15, 15]
                                });

                                liveBusMarker = L.marker([lat, lng], { icon: busIcon, zIndexOffset: 2000 })
                                    .addTo(map)
                                    .bindPopup(`<b>Bus ${busNo}</b><br>Speed: ${data.speed || 0} km/h`);

                                liveBusMarker.openPopup(); // Optional: show on first load
                            }
                        }
                    }
                });
            }
        }
    } catch (e) { console.error("Error initializing live tracking", e); }

    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds());
    }

    // Edit Logic
    let isEditing = false;
    const editBtn = document.querySelector('.btn-primary');

    editBtn.addEventListener('click', function () {
        if (!isEditing) {
            // Switch to Edit Mode
            isEditing = true;
            this.innerHTML = '<span style="font-size:1rem; margin-right:6px">üíæ</span> Save Changes';
            this.style.backgroundColor = '#10b981'; // Green color

            // Toggle visibility
            toggleFields(true);
        } else {
            // Save Changes
            saveChanges();
        }
    });

    function toggleFields(showInput) {
        const fields = ['route_name', 'distance', 'assigned_bus'];

        fields.forEach(field => {
            const displayEl = document.getElementById('display_' + field);
            const inputEl = document.getElementById('edit_' + field);
            if (displayEl && inputEl) {
                displayEl.style.display = showInput ? 'none' : 'block';
                inputEl.style.display = showInput ? 'block' : 'none';
            }
        });

        // Special handling for Start/End Points
        document.getElementById('display_points').style.display = showInput ? 'none' : 'block';
        document.getElementById('edit_points').style.display = showInput ? 'block' : 'none';

        // Special handling for Stops
        document.getElementById('display_stops').style.display = showInput ? 'none' : 'block';
        const stopsContainer = document.getElementById('edit_stops_container');
        stopsContainer.style.display = showInput ? 'block' : 'none';

        if (showInput) {
            // Populate stops inputs
            const stopsList = document.getElementById('stops_list');
            stopsList.innerHTML = ''; // Clear existing

            const tiles = document.querySelectorAll('#display_stops .stop-tile');
            if (tiles.length > 0) {
                tiles.forEach(tile => {
                    const name = tile.getAttribute('data-name');
                    const fee = tile.getAttribute('data-fee');
                    const stopId = tile.getAttribute('data-id') || ""; // Assuming we start storing ID in tile

                    // If we don't have ID (legacy data), we just render it. 
                    // But optimally we should try to match. For now, we allow legacy stops to be carried over or re-added.
                    renderStopItem(stopId, name, fee);
                });
            }
        }
    }

    function addSelectedStop() {
        const selector = document.getElementById('geo_stop_selector');
        const selectedOption = selector.options[selector.selectedIndex];

        if (!selectedOption.value) {
            alert('Please select a stop first.');
            return;
        }

        const id = selectedOption.value;
        const name = selectedOption.getAttribute('data-name');
        const fee = selectedOption.getAttribute('data-fee');

        // Prevent duplicate IDs if possible, but for routes maybe same stop occurs twice? (unlikely for "Stop")
        // Let's allow duplicates for now or check:
        // if (document.querySelector(`.stop-item[data-id="${id}"]`)) { alert("Stop already added"); return; }

        renderStopItem(id, name, fee);
        selector.value = ""; // Reset
    }

    function renderStopItem(id, name, fee) {
        const container = document.getElementById('stops_list');
        const div = document.createElement('div');
        div.className = 'stop-item';
        div.setAttribute('data-id', id);

        // Visual only, not editable inputs anymore (global stops)
        // We might want to allow custom "Trip Fee" override? 
        // For now, simple read-only view with remove button
        div.innerHTML = `
             <span class="stop-number">üìç</span>
             <span style="flex: 1; margin-left:8px; font-weight:500;">${name}</span>
             <span class="badge badge-secondary">‚Çπ${fee}</span>
             <input type="hidden" class="stop-id-input" value="${id}">
             <input type="hidden" class="stop-name-input" value="${name}">
             <input type="hidden" class="stop-fee-input" value="${fee}">
             <button type="button" class="remove-stop-btn" onclick="this.parentElement.remove()">√ó</button>
         `;
        container.appendChild(div);
    }

    function saveChanges() {
        const btn = document.querySelector('.btn-primary');
        const originalText = '<span style="margin-right:8px">‚úèÔ∏è</span> Edit Route';
        btn.innerText = 'Saving...';
        btn.disabled = true;

        // Collect stops
        const stopItems = document.querySelectorAll('.stop-item');
        const stops = [];
        stopItems.forEach(item => {
            const idInput = item.querySelector('.stop-id-input');
            const nameInput = item.querySelector('.stop-name-input');
            const feeInput = item.querySelector('.stop-fee-input');

            stops.push({
                id: idInput.value || null, // Store ID if available
                name: nameInput.value,
                fee: parseFloat(feeInput.value) || 0
            });
        });

        const data = {
            route_name: document.getElementById('edit_route_name').value,
            start_point: document.getElementById('edit_start_point').value,
            end_point: document.getElementById('edit_end_point').value,
            stops: stops,
            distance: document.getElementById('edit_distance').value,
            assigned_bus: document.getElementById('edit_assigned_bus').value
        };

        fetch("{{ url_for('api.api_update_route', route_id=route.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Route details updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = ''; // Reset color
                    isEditing = false;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.backgroundColor = ''; // Reset color
                isEditing = false;
            });
    }
</script>
{% endblock %}