{% extends "base.html" %}

{% set active_page = 'routes' %}

{% block title %}Smart Bus Admin Panel - Add Route{% endblock %}

{% block header_title %}Smart Bus Admin • Add Route{% endblock %}

{% block content %}
<div class="form-container">
    <h2 class="form-section-title">Add New Route</h2>
    <form id="addRouteForm" class="form-grid">
        <div class="form-group">
            <label class="form-label">Route Name</label>
            <input type="text" id="route_name" class="form-input" placeholder="e.g. Route 1" required>
        </div>

        <div class="split-row">
            <div>
                <label class="form-label">Start Point</label>
                <input type="text" id="start_point" class="form-input" placeholder="Start Location" required>
            </div>
            <div>
                <label class="form-label">End Point</label>
                <input type="text" id="end_point" class="form-input" placeholder="End Location" required>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Stops</label>
            <div id="stops-container">
                <!-- Stops will be added here -->
                <div class="stop-item">
                    <span class="stop-number">1.</span>
                    <input type="text" class="form-input stop-name-input" placeholder="Stop Name" required>
                    <input type="number" class="form-input stop-fee-input" placeholder="Fee (₹)" required min="0">
                </div>
            </div>
            <button type="button" class="add-stop-btn" onclick="addStop()">
                <span>+</span> Add Stop
            </button>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('routes.routes') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Save Route</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function addStop() {
        const container = document.getElementById('stops-container');
        const count = container.children.length + 1;

        const div = document.createElement('div');
        div.className = 'stop-item';
        div.innerHTML = `
            <span class="stop-number">${count}.</span>
            <input type="text" class="form-input stop-name-input" placeholder="Stop Name" required>
            <input type="number" class="form-input stop-fee-input" placeholder="Fee (₹)" required min="0">
            <button type="button" class="remove-stop-btn" onclick="removeStop(this)">&times;</button>
        `;
        container.appendChild(div);
    }

    function removeStop(btn) {
        btn.parentElement.remove();
        // Renumber stops
        const container = document.getElementById('stops-container');
        Array.from(container.children).forEach((child, index) => {
            child.querySelector('span').innerText = (index + 1) + '.';
        });
    }

    document.getElementById('addRouteForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = {
            route_name: document.getElementById('route_name').value,
            start_point: document.getElementById('start_point').value,
            end_point: document.getElementById('end_point').value,
            stops: []
        };

        // Collect stops and fees
        const stopItems = document.querySelectorAll('.stop-item');
        stopItems.forEach(item => {
            const nameInput = item.querySelector('.stop-name-input');
            const feeInput = item.querySelector('.stop-fee-input');

            if (nameInput && nameInput.value.trim() !== '') {
                formData.stops.push({
                    name: nameInput.value.trim(),
                    fee: feeInput ? parseFloat(feeInput.value) || 0 : 0
                });
            }
        });

        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Saving...';

        fetch("{{ url_for('api.api_add_route') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Route Added Successfully!');
                    window.location.href = "{{ url_for('routes.routes') }}";
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerText = originalText;
            });
    });
</script>
{% endblock %}