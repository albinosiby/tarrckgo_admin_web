{% extends "base.html" %}

{% set active_page = 'students' %}

{% block title %}Smart Bus Admin Panel - Student Details{% endblock %}

{% block header_title %}Smart Bus Admin ‚Ä¢ Student Details{% endblock %}

{% block content %}
<div class="detail-layout">

    <!-- LEFT COLUMN: Profile Summary -->
    <div class="profile-sidebar">
        <div class="card">
            <div class="profile-avatar-large">
                {% if student.profile_photo_url %}
                <img src="{{ student.profile_photo_url }}" alt="Profile">
                {% else %}
                {{ student.full_name[0] if student.full_name else '?' }}
                {% endif %}
            </div>

            <div id="edit_photo_container" style="display:none; margin-bottom: 10px;">
                <label for="edit_student_photo" class="btn btn-secondary"
                    style="font-size:0.8rem; padding:4px 8px;">Change Photo</label>
                <input type="file" id="edit_student_photo" style="display: none;" accept="image/*">
            </div>

            <h2 class="profile-name">
                <span id="display_full_name">{{ student.full_name }}</span>
                <input type="text" id="edit_full_name" class="form-input-edit" value="{{ student.full_name }}"
                    style="display:none;">
            </h2>

            <div class="profile-meta">
                <div>Roll No: <span id="display_roll_number" style="font-family:monospace">{{ student.roll_number
                        }}</span>
                    <input type="text" id="edit_roll_number" class="form-input-edit" value="{{ student.roll_number }}"
                        style="display:none;">
                </div>
                <div style="margin-top:4px">{{ student.email }}</div>
                <input type="email" id="edit_email" class="form-input-edit" value="{{ student.email }}"
                    style="display:none; margin-top:4px;">
            </div>

            <div class="badge badge-success" style="font-size: 0.9rem; padding: 6px 16px;">Active Student</div>

            <div style="margin-top: 24px;">
                <button id="edit-profile-btn" class="btn btn-primary" style="width:100%; justify-content:center;">
                    <span style="margin-right:8px">‚úèÔ∏è</span> Edit Profile
                </button>
            </div>

            <div style="margin-top: 12px;">
                <button onclick="deleteStudent('{{ student.id }}', '{{ student.full_name }}')" class="btn btn-danger"
                    style="width:100%; justify-content:center;">
                    üóëÔ∏è Delete Student
                </button>
            </div>
        </div>

        <!-- Attendance Summary Card could go here -->
        <div class="card" style="margin-top: 20px; text-align: left;">
            <div class="section-title">Attendance</div>
            <!-- <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>Overall</div>
                <div style="font-weight:700; color:var(--success);">92%</div>
            </div> -->
            <div style="margin-top:10px;">
                <a href="{{ url_for('students.student_attendance_history', student_id=student.id) }}"
                    style="font-size:0.85rem; color:var(--primary); text-decoration:none;">View Full History ‚Üí</a>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN: Details & Fees -->
    <div class="main-content">

        <!-- Personal & Transport Details -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="section-title">
                Personal & Transport Details
            </div>

            <div class="detail-grid">
                <div class="info-group">
                    <label class="info-label">Batch / Class</label>
                    <div class="value" id="display_batch">{{ student.batch }}</div>
                    <input type="text" id="edit_batch" class="form-input-edit" value="{{ student.batch }}"
                        style="display:none;">
                </div>
                <div class="info-group">
                    <label class="info-label">Phone Number</label>
                    <div class="value" id="display_student_phone">{{ student.student_phone }}</div>
                    <input type="tel" id="edit_student_phone" class="form-input-edit"
                        value="{{ student.student_phone }}" disabled
                        style="display:none; opacity:0.6; cursor:not-allowed">
                </div>
                <div class="info-group">
                    <label class="info-label">Date of Birth</label>
                    <div class="value" id="display_dob">{{ student.dob }}</div>
                    <input type="date" id="edit_dob" class="form-input-edit" value="{{ student.dob }}" disabled
                        style="display:none;">
                </div>
                <div class="info-group">
                    <label class="info-label">Parent Name</label>
                    <div class="value" id="display_parent_name">{{ student.parent_name }}</div>
                    <input type="text" id="edit_parent_name" class="form-input-edit" value="{{ student.parent_name }}"
                        disabled style="display:none;">
                </div>
                <div class="info-group">
                    <label class="info-label">Parent Phone</label>
                    <div class="value" id="display_parent_phone">{{ student.parent_phone }}</div>
                    <input type="tel" id="edit_parent_phone" class="form-input-edit" value="{{ student.parent_phone }}"
                        style="display:none;">
                </div>
                <div class="info-group" style="grid-column: 1 / -1">
                    <label class="info-label">Address</label>
                    <div class="value" id="display_address">{{ student.address }}</div>
                    <textarea id="edit_address" class="form-input-edit"
                        style="display:none;">{{ student.address }}</textarea>
                </div>
            </div>

            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--glass-border);">
                <h4
                    style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:12px; text-transform:uppercase;">
                    Transport Assignment</h4>
                <div class="detail-grid">
                    <div class="info-group">
                        <label class="info-label">Assigned Bus</label>
                        <div class="value" id="display_bus_number">{{ student.bus_number or 'No Bus' }}</div>
                        <select id="edit_bus_number" class="form-input-edit" style="display:none;"
                            onchange="updateStops()">
                            <option value="">Select Bus...</option>
                            {% for bus in buses %}
                            <option value="{{ bus.bus_number }}" {% if student.bus_number==bus.bus_number %}selected{%
                                endif %}>
                                {{ bus.bus_number }} - {{ bus.route }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Bus Stop</label>
                        <div class="value" id="display_bus_stop">{{ student.bus_stop or '-' }}</div>
                        <select id="edit_bus_stop" class="form-input-edit" style="display:none;" onchange="updateFee()">
                            <option value="{{ student.bus_stop }}">{{ student.bus_stop }}</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Route</label>
                        <div class="value" id="display_route_name">{{ student.route_name or '-' }}</div>
                        <!-- Route is derived from bus -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Fees Section -->
        <div class="card">
            <div class="section-title">
                <span>Fee & Payments</span>
                <button onclick="togglePaymentForm()" id="show-payment-form-btn" class="btn btn-secondary"
                    style="padding:4px 12px; font-size:0.85rem;">+ Record Payment</button>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">Total Fee</div>
                    <div class="stat-value" id="display_fee_amount">‚Çπ {{ student.fee_amount }}</div>
                    <input type="number" id="edit_fee_amount" class="form-input-edit" value="{{ student.fee_amount }}"
                        style="display:none;">

                    <div id="display_payment_type"
                        style="font-size:0.75rem; color:var(--text-secondary); margin-top:4px">{{
                        student.payment_type }}</div>
                    {% if org_payment_type %}
                    <input type="text" id="edit_payment_type" class="form-input-edit" value="{{ org_payment_type }}"
                        readonly style="display:none; font-size:0.8rem; margin-top:4px">
                    {% else %}
                    <select id="edit_payment_type" class="form-input-edit" style="display:none; margin-top:4px">
                        <option value="Monthly" {% if student.payment_type=='Monthly' %}selected{% endif %}>Monthly
                        </option>
                        <option value="Annual" {% if student.payment_type=='Annual' %}selected{% endif %}>Annual
                        </option>
                    </select>
                    {% endif %}
                </div>
                <div class="stat-box">
                    <div class="stat-label">Amount Paid</div>
                    <div class="stat-value" style="color:var(--success)">‚Çπ {{ total_paid }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Balance Due</div>
                    <div class="stat-value" style="color:var(--warning)">‚Çπ {{ balance }}
                    </div>
                </div>
            </div>

            <!-- Add Payment Form -->
            <div id="payment-form-container"
                style="display:none; background:rgba(255,255,255,0.03); padding:20px; border-radius:12px; margin-bottom:24px; border:1px solid var(--glass-border);">
                <h4 style="margin-bottom:16px; color:var(--text-primary); font-size:1rem;">New Payment</h4>
                <form id="addPaymentForm">
                    <div class="detail-grid">
                        <div class="info-group">
                            <label class="info-label">Amount (‚Çπ)</label>
                            <input type="number" id="pay_amount" class="form-input-edit" required>
                        </div>
                        <div class="info-group">
                            <label class="info-label">Date</label>
                            <input type="date" id="pay_date" class="form-input-edit" required>
                        </div>
                        <div class="info-group">
                            <label class="info-label">Mode</label>
                            <select id="pay_mode" class="form-input-edit" required>
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="info-group">
                            <label class="info-label">Ref / Transaction ID</label>
                            <input type="text" id="pay_ref" class="form-input-edit">
                        </div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; margin-top:16px; gap:12px;">
                        <button type="button" class="btn btn-secondary" onclick="togglePaymentForm()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Record</button>
                    </div>
                </form>
            </div>

            <!-- History Table -->
            <div style="overflow-x: auto;">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Mode</th>
                            <th>Ref ID</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payments %}
                        <tr class="{{ 'history-row' if payment.is_history else '' }}">
                            <td>{{ payment.date }}</td>
                            <td>{{ payment.mode }}</td>
                            <td>{{ payment.reference_id or '-' }}</td>
                            <td style="color:var(--success); font-weight:600;">+ ‚Çπ {{ payment.amount }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center;color:var(--text-muted);">No payment history.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script id="buses-data" type="application/json">{{ buses | tojson }}</script>
<script id="routes-data" type="application/json">{{ routes | tojson }}</script>
<script id="student-bus-stop" type="application/json">{{ student.bus_stop | tojson }}</script>
<script>
    const busesData = JSON.parse(document.getElementById('buses-data').textContent);
    const routesData = JSON.parse(document.getElementById('routes-data').textContent);

    let isEditing = false;
    const editBtn = document.getElementById('edit-profile-btn');

    if (editBtn) {
        editBtn.addEventListener('click', function () {
            // Check if this is indeed the edit profile button by text content or position
            if (this.innerText.includes('Edit Profile') || this.innerText.includes('Save Changes')) {
                if (!isEditing) {
                    // Switch to Edit Mode
                    isEditing = true;
                    this.innerHTML = '<span style="font-size:1rem; margin-right:6px">üíæ</span> Save Changes';
                    this.style.backgroundColor = '#10b981'; // Green color

                    // Toggle visibility
                    toggleFields(true);
                } else {
                    // Save Changes
                    saveChanges();
                }
            } else {
                // Must be the "Record Payment" button if not matched, ignore
            }
        });
    }

    function toggleFields(showInput) {
        // Check balance for transport fields - REMOVED per user request
        // const balance = Number('{{ balance }}');
        // const canEditTransport = balance <= 0;
        const canEditTransport = true; // Always allow editing

        const fields = [
            'full_name', 'roll_number', 'email', 'student_phone', 'dob', 'batch', 'address',
            'parent_name', 'parent_phone'
        ];

        // Transport fields separate
        const transportFields = ['route', 'bus_number', 'bus_stop', 'payment_type', 'fee_amount'];

        fields.forEach(field => {
            const displayEl = document.getElementById('display_' + field);
            const inputEl = document.getElementById('edit_' + field);
            if (displayEl && inputEl) {
                displayEl.style.display = showInput ? 'none' : 'block';
                inputEl.style.display = showInput ? 'block' : 'none';
            }
        });

        transportFields.forEach(field => {
            const displayEl = document.getElementById('display_' + field);
            const inputEl = document.getElementById('edit_' + field);
            if (displayEl && inputEl) {
                displayEl.style.display = showInput ? 'none' : 'block';
                // Always show input if we are in edit mode
                if (showInput) {
                    inputEl.style.display = 'block';
                } else {
                    inputEl.style.display = 'none';
                }
            }
        });

        // Alert removed
        // if (showInput && !canEditTransport) {
        //    alert("Transport details cannot be edited until the fee balance is cleared.");
        // }

        // Photo Edit
        const photoContainer = document.getElementById('edit_photo_container');
        if (photoContainer) photoContainer.style.display = showInput ? 'block' : 'none';

        if (showInput) {
            const busSelect = document.getElementById('edit_bus_number');
            const currentStop = JSON.parse(document.getElementById('student-bus-stop').textContent);

            // Trigger initial stop population based on current route
            if (busSelect.value) {
                updateStops(currentStop);
            }
        }
    }

    function updateStops(currentStop = null) {
        const busSelect = document.getElementById('edit_bus_number');
        const stopSelect = document.getElementById('edit_bus_stop');
        const routeDisplay = document.getElementById('display_route_name');
        const busNumber = busSelect.value;
        const currentVal = currentStop || stopSelect.value;

        stopSelect.innerHTML = '<option value="">Select Stop...</option>';
        if (routeDisplay) routeDisplay.textContent = '-';

        if (!busNumber) return;

        // Find the selected bus object
        const selectedBus = busesData.find(b => b.bus_number === busNumber);

        if (selectedBus && selectedBus.route && routeDisplay) {
            routeDisplay.textContent = selectedBus.route;
        }

        if (!selectedBus || !selectedBus.route) return;

        // Find route
        const selectedRoute = routesData.find(r => r.route_name === selectedBus.route);

        if (selectedRoute) {
            let stops = selectedRoute.stops || [];
            if (typeof stops === 'string') {
                stops = stops.split(',').map(s => s.trim());
            }

            if (Array.isArray(stops)) {
                stops.forEach(stop => {
                    const option = document.createElement('option');
                    let stopName = stop;
                    let stopFee = 0;

                    if (typeof stop === 'object') {
                        stopName = stop.name || '';
                        stopFee = stop.fee || 0;
                    }

                    option.value = stopName;
                    option.textContent = stopName;
                    option.setAttribute('data-fee', stopFee);

                    if (stopName === currentVal) {
                        option.selected = true;
                    }
                    stopSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = "No stops found for this route";
                stopSelect.appendChild(option);
            }
        }
    }

    function updateFee() {
        const stopSelect = document.getElementById('edit_bus_stop');
        const feeInput = document.getElementById('edit_fee_amount');

        const selectedOption = stopSelect.options[stopSelect.selectedIndex];
        if (selectedOption) {
            const fee = selectedOption.getAttribute('data-fee');
            if (fee) {
                feeInput.value = fee;
            }
        }
    }

    function saveChanges() {
        const btn = document.getElementById('edit-profile-btn');
        const originalText = '<span style="font-size:1rem; margin-right:6px">‚úé</span> Edit Profile';
        btn.innerText = 'Saving...';
        btn.disabled = true;

        const formData = new FormData();
        formData.append('full_name', document.getElementById('edit_full_name').value);
        formData.append('roll_number', document.getElementById('edit_roll_number').value);
        formData.append('email', document.getElementById('edit_email').value);
        formData.append('dob', document.getElementById('edit_dob').value);
        formData.append('batch', document.getElementById('edit_batch').value);
        formData.append('address', document.getElementById('edit_address').value);

        // Transport
        formData.append('bus_number', document.getElementById('edit_bus_number').value);
        formData.append('bus_stop', document.getElementById('edit_bus_stop').value);

        const busId = busesData.find(b => b.bus_number === document.getElementById('edit_bus_number').value)?.id || '';
        formData.append('bus_id', busId);

        formData.append('payment_type', document.getElementById('edit_payment_type').value);
        formData.append('fee_amount', document.getElementById('edit_fee_amount').value);
        formData.append('parent_name', document.getElementById('edit_parent_name').value);
        // parent_phone is disabled

        const fileInput = document.getElementById('edit_student_photo');
        if (fileInput && fileInput.files.length > 0) {
            formData.append('student_photo', fileInput.files[0]);
        }

        fetch("{{ url_for('api.api_update_student', roll_number=student.id) }}", {
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Student details updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = ''; // Reset color
                    isEditing = false;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.backgroundColor = ''; // Reset color
                isEditing = false;
            });
    }

    function togglePaymentForm() {
        const formContainer = document.getElementById('payment-form-container');
        const showBtn = document.getElementById('show-payment-form-btn');

        if (formContainer.style.display === 'none') {
            formContainer.style.display = 'block';
            showBtn.style.display = 'none';

            // Set default date to today
            document.getElementById('pay_date').valueAsDate = new Date();
        } else {
            formContainer.style.display = 'none';
            showBtn.style.display = 'block';
        }
    }

    document.getElementById('addPaymentForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Saving...';

        const formData = {
            amount: document.getElementById('pay_amount').value,
            date: document.getElementById('pay_date').value,
            mode: document.getElementById('pay_mode').value,
            reference_id: document.getElementById('pay_ref').value
        };

        fetch("{{ url_for('api.api_add_payment', student_id=student.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Payment Added Successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerText = originalText;
            });
    });

    function deleteStudent(studentId, studentName) {
        if (confirm(`Are you sure you want to delete ${studentName}? This action cannot be undone.`)) {
            fetch(`/api/delete_student/${studentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Student deleted successfully.');
                        window.location.href = "{{ url_for('students.students') }}";
                    } else {
                        alert('Error deleting student: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the student.');
                });
        }
    }

    function resetFeeStatus() {
        if (confirm("Are you sure you want to RESET the fee status for this student?\n\nThis will set:\n- Paid Amount to 0\n- Due Amount to Full Fee\n- Travel Permission to FALSE\n\nThis action cannot be undone.")) {
            fetch("{{ url_for('api.api_reset_fee_status', student_id=student.id) }}", {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred.');
                });
        }
    }
</script>
{% endblock %}