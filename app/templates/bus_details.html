{% extends "base.html" %}

{% set active_page = 'buses' %}

{% block title %}Smart Bus Admin Panel - Bus Details{% endblock %}

{% block header_title %}Smart Bus Admin â€¢ Bus Details{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    .detail-label {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-bottom: 4px;
    }

    .detail-value {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-dark);
    }

    .detail-group {
        margin-bottom: 16px;
    }

    .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
    }

    .profile-img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #9ca3af;
        object-fit: cover;
    }

    .edit-input {
        display: none;
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 1rem;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <!-- Bus Profile Card -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-title-row"
            style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3>Bus Profile</h3>
            <button id="editBtn" class="btn btn-primary" onclick="toggleEditMode()">
                <span style="font-size:1rem; margin-right:6px">âœŽ</span> Edit
            </button>
        </div>

        <div class="profile-header">
            <div class="profile-img">ðŸšŒ</div>
            <div>
                <h2 style="font-size: 1.5rem; margin-bottom: 4px;">{{ bus.bus_number }}</h2>
                <div style="color: var(--text-light);">Registration: {{ bus.registration_no }}</div>
                <span class="badge badge-success"
                    style="color:var(--success);background:#dcfce7;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600; margin-top: 8px; display: inline-block;">Active</span>
            </div>
        </div>

        <div class="split-row">
            <!-- Bus Info -->
            <div>
                <h4 style="margin-bottom: 16px; color: var(--primary);">Bus Information</h4>
                <div class="detail-group">
                    <div class="detail-label">Bus ID</div>
                    <div class="detail-value" style="font-family:monospace; user-select:all;">{{ bus.id
                        }}</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Capacity</div>
                    <div id="display-capacity" class="detail-value">{{ bus.capacity }} Seats</div>
                    <input type="number" id="input-capacity" class="edit-input" value="{{ bus.capacity }}">
                </div>
                <div class="detail-group">
                    <div class="detail-label">Model</div>
                    <div id="display-model" class="detail-value">{{ bus.model or 'N/A' }}</div>
                    <input type="text" id="input-model" class="edit-input" value="{{ bus.model or '' }}">
                </div>
            </div>

            <!-- Assignment Info -->
            <div>
                <h4 style="margin-bottom: 16px; color: var(--primary);">Assignment</h4>
                <div class="detail-group">
                    <div class="detail-label">Assigned Driver</div>
                    <div id="display-driver" class="detail-value">{{ bus.driver_name_display }}
                    </div>
                    <select id="input-driver" class="edit-input">
                        <option value="">Unassigned</option>
                        {% for driver in drivers %}
                        <option value="{{ driver.id }}" data-name="{{ driver.full_name }}" {% if
                            bus.driver_name==driver.full_name %}selected{% endif %}>{{ driver.full_name
                            }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Route</div>
                    <div id="display-route" class="detail-value">{{ bus.route or 'N/A' }}</div>
                    <select id="input-route" class="edit-input">
                        <option value="">N/A</option>
                        {% for route in routes %}
                        <option value="{{ route.route_name }}" data-id="{{ route.id }}" {% if
                            bus.route==route.route_name %}selected{% endif %}>{{ route.route_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <h4 style="margin-bottom: 16px; color: var(--primary);">Service & Compliance</h4>
            <div class="split-row">
                <div>
                    <div class="detail-group">
                        <div class="detail-label">Last Service Date</div>
                        <div id="display-last-service" class="detail-value">{{ bus.last_service_date or
                            'N/A' }}</div>
                        <input type="date" id="input-last-service" class="edit-input"
                            value="{{ bus.last_service_date or '' }}">
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Next Service Due</div>
                        <div id="display-next-service" class="detail-value">{{ bus.next_service_due or
                            'N/A' }}</div>
                        <input type="date" id="input-next-service" class="edit-input"
                            value="{{ bus.next_service_due or '' }}">
                    </div>
                </div>
                <div>
                    <div class="detail-group">
                        <div class="detail-label">Insurance Expiry</div>
                        <div id="display-insurance" class="detail-value">{{ bus.insurance_expiry or
                            'N/A' }}</div>
                        <input type="date" id="input-insurance" class="edit-input"
                            value="{{ bus.insurance_expiry or '' }}">
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Fitness Cert. Expiry</div>
                        <div id="display-fitness" class="detail-value">{{ bus.fitness_expiry or 'N/A' }}
                        </div>
                        <input type="date" id="input-fitness" class="edit-input" value="{{ bus.fitness_expiry or '' }}">
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                <h4 style="color: var(--primary); margin:0;">Current Boarded Students</h4>
                <span class="badge"
                    style="background:var(--primary); color:white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">
                    {{ boarded_students|length }} On Board
                </span>
            </div>

            {% if boarded_students %}
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Roll No.</th>
                            <th>Parent Phone</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in boarded_students %}
                        <tr>
                            <td style="width: 60px;">
                                {% if student.profile_photo_url %}
                                <img src="{{ student.profile_photo_url }}" alt="Photo"
                                    style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                <div
                                    style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                    ðŸ‘¤</div>
                                {% endif %}
                            </td>
                            <td>
                                <div style="font-weight: 500;">{{ student.full_name }}</div>
                            </td>
                            <td>{{ student.roll_number }}</td>
                            <td>{{ student.parent_phone or '-' }}</td>
                            <td>
                                <span class="badge badge-success"
                                    style="color:var(--success);background:#dcfce7;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600">On
                                    Board</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div
                style="background: #f9fafb; padding: 20px; border-radius: 8px; text-align: center; color: var(--text-light);">
                <div style="font-size: 2rem; margin-bottom: 8px;">ðŸšŒ</div>
                <div>No students currently boarded</div>
            </div>
            {% endif %}
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                <h4 style="color: var(--primary); margin:0;">Assigned Students</h4>
                <span class="badge"
                    style="background:#6b7280; color:white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem;">
                    {{ assigned_students|length }} Assigned
                </span>
            </div>

            {% if assigned_students %}
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Roll No.</th>
                            <th>Class</th>
                            <th>Stop</th>
                            <th>Parent Phone</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in assigned_students %}
                        <tr>
                            <td style="width: 60px;">
                                {% if student.profile_photo_url %}
                                <img src="{{ student.profile_photo_url }}" alt="Photo"
                                    style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                <div
                                    style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                    ðŸ‘¤</div>
                                {% endif %}
                            </td>
                            <td>
                                <div style="font-weight: 500;">
                                    <a href="{{ url_for('students.student_details', student_id=student.id) }}"
                                        style="text-decoration:none; color:inherit;">
                                        {{ student.full_name }}
                                    </a>
                                </div>
                            </td>
                            <td>{{ student.roll_number }}</td>
                            <td>{{ student.batch or '-' }}</td>
                            <td>{{ student.bus_stop or '-' }}</td>
                            <td>{{ student.parent_phone or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div
                style="background: #f9fafb; padding: 20px; border-radius: 8px; text-align: center; color: var(--text-light);">
                <div style="font-size: 2rem; margin-bottom: 8px;">ðŸ‘¥</div>
                <div>No students assigned to this bus</div>
            </div>
            {% endif %}
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <h4 style="margin-bottom: 16px; color: var(--primary);">Trip History</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Students</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trip in trip_history %}
                        <tr>
                            <td>{{ trip.date }}</td>
                            <!-- Basic slicing for time, assuming ISO format like "2025-12-12T10:08:19..." -->
                            <td>
                                {{ trip.startTime[11:16] if trip.startTime|length > 16 else trip.startTime }}
                                -
                                {{ trip.endTime[11:16] if trip.endTime and trip.endTime|length > 16 else (trip.endTime
                                or '-') }}
                            </td>
                            <td>{{ trip.type|capitalize }}</td>

                            <td>{{ trip.boardedStudents }} / {{ trip.totalStudents }}</td>
                            <td>{{ trip.durationMinutes }} min</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" style="text-align:center; padding: 20px; color: var(--text-light);">No trip
                                history found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 16px; text-align: center;">
                <a href="{{ url_for('buses.bus_trip_history', bus_id=bus.id) }}" class="btn"
                    style="background: #e0e7ff; color: var(--primary); text-decoration: none; display: inline-block;">
                    View Full History &rarr;
                </a>
            </div>
        </div>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <h4 style="margin-bottom: 16px; color: var(--primary);">Live Location</h4>
            <div id="single-bus-map" style="height: 400px; width: 100%; border-radius: 8px; z-index: 1;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('single-bus-map')) {
            const map = L.map('single-bus-map').setView([12.096, 75.558], 14); // Default center (Chemperi)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const uid = "{{ session['uid'] }}";
            const busId = "{{ bus.id }}";
            const busNo = "{{ bus.bus_number }}";
            let marker = null;

            const busRef = rtdb.ref(`organizations/${uid}/bus_location/${busId}`);
            console.log(`[DEBUG] Listening to RTDB path: organizations/${uid}/bus_location/${busId}`);

            busRef.on('value', (snapshot) => {
                const data = snapshot.val();
                console.log("[DEBUG] Received data:", data);

                if (data && data.latitude != null && data.longitude != null) {
                    const lat = parseFloat(data.latitude);
                    const lng = parseFloat(data.longitude);

                    if (isNaN(lat) || isNaN(lng)) {
                        console.error("[DEBUG] Invalid coordinates:", lat, lng);
                        return;
                    }

                    if (marker) {
                        marker.setLatLng([lat, lng]);
                        marker.setPopupContent(`<b>Bus ${busNo}</b><br>Speed: ${data.speed} km/h`);
                    } else {
                        marker = L.marker([lat, lng]).addTo(map)
                            .bindPopup(`<b>Bus ${busNo}</b><br>Speed: ${data.speed} km/h`)
                            .openPopup();
                    }
                    map.setView([lat, lng], 14); // Auto-center
                } else {
                    console.warn("[DEBUG] Data missing latitude/longitude or is null. Data:", data);
                }
            }, (error) => {
                console.error("Error fetching bus location:", error);
            });

        }
    });

    let isEditing = false;

    function toggleEditMode() {
        if (isEditing) {
            saveChanges();
        } else {
            isEditing = true;
            document.getElementById('editBtn').innerHTML = '<span style="font-size:1rem; margin-right:6px">ðŸ’¾</span> Save Changes';
            document.getElementById('editBtn').classList.replace('btn-primary', 'btn-success'); // Optional: change color
            document.getElementById('editBtn').style.backgroundColor = 'var(--success)';
            document.getElementById('editBtn').style.borderColor = 'var(--success)';

            // Show inputs, hide displays
            const fields = ['capacity', 'model', 'driver', 'route', 'last-service', 'next-service', 'insurance', 'fitness'];
            fields.forEach(field => {
                document.getElementById(`display-${field}`).style.display = 'none';
                document.getElementById(`input-${field}`).style.display = 'block';
            });
        }
    }

    function saveChanges() {
        const btn = document.getElementById('editBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerText = 'Saving...';

        const driverSelect = document.getElementById('input-driver');
        const selectedOption = driverSelect.options[driverSelect.selectedIndex];
        const driverId = driverSelect.value;
        const driverName = selectedOption.getAttribute('data-name') || (driverId === '' ? 'Unassigned' : selectedOption.innerText);

        const data = {
            capacity: document.getElementById('input-capacity').value,
            model: document.getElementById('input-model').value,
            driver_name: driverName,
            driver_id: driverId === '' ? null : driverId,
            route: document.getElementById('input-route').value,
            route_id: document.getElementById('input-route').options[document.getElementById('input-route').selectedIndex].getAttribute('data-id') || '',
            last_service_date: document.getElementById('input-last-service').value,
            next_service_due: document.getElementById('input-next-service').value,
            insurance_expiry: document.getElementById('input-insurance').value,
            fitness_expiry: document.getElementById('input-fitness').value
        };
        fetch("{{ url_for('api.api_update_bus', bus_id=bus.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Bus details updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }
</script>
{% endblock %}