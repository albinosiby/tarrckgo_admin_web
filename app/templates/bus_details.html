{% extends "base.html" %}

{% set active_page = 'buses' %}

{% block title %}Smart Bus Admin Panel - Bus Details{% endblock %}

{% block header_title %}Smart Bus Admin ‚Ä¢ Bus Details{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block content %}
<div class="page-container">

    <!-- LEFT COLUMN: Bus Profile -->
    <div class="profile-sidebar">
        <div class="modern-card">
            <div class="profile-avatar-large">
                üöå
            </div>

            <h2 class="profile-name">
                Bus {{ bus.bus_number }}
            </h2>

            <div class="profile-meta">
                <div>{{ bus.registration_no }}</div>
                <div style="font-family:monospace; font-size: 0.8rem; margin-top:4px; color:var(--text-muted);">ID: {{
                    bus.id }}
                </div>
            </div>

            <div class="status-badge badge badge-success">Active</div>

            <div style="margin-top: 24px;">
                <!-- Updated button to use classes -->
                <button id="editBtn" class="btn btn-primary" style="width:100%; justify-content:center;"
                    onclick="toggleEditMode()">
                    <span style="margin-right:8px">‚úèÔ∏è</span> Edit Bus
                </button>
            </div>

            <div style="margin-top: 12px;">
                <!-- Placeholder for future functionality, or implement delete bus if available -->
                <!-- <button class="btn" style="width:100%; justify-content:center; background:#fee2e2; color:#ef4444; border:none;">
                    üóëÔ∏è Delete Bus
                </button> -->
            </div>
        </div>

        <!-- Driver Summary -->
        <div class="modern-card" style="margin-top: 20px; text-align: left;">
            <div class="section-title">Assigned Driver</div>
            {% if bus.driver_name_display and bus.driver_name_display != 'Unassigned' %}
            <div style="display:flex; align-items:center; gap:12px;">
                <div
                    style="width:40px; height:40px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem;">
                    üßë‚Äç‚úàÔ∏è</div>
                <div>
                    <div style="font-weight:600; color:var(--text-primary);">{{ bus.driver_name_display }}</div>
                    <!-- <div style="font-size:0.8rem; color:var(--text-secondary);">Phone number here</div> -->
                </div>
            </div>
            {% else %}
            <div style="color:var(--text-secondary); font-style:italic;">No driver assigned</div>
            {% endif %}
        </div>
    </div>

    <!-- RIGHT COLUMN: Details & Tracking -->
    <div class="main-content">

        <!-- Stats & Info -->
        <div class="modern-card" style="margin-bottom: 24px;">
            <div class="section-title">Overview & Status</div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">Total Capacity</div>
                    <div class="stat-value" id="display-capacity">{{ bus.capacity }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">On Board</div>
                    <div class="stat-value" style="color:var(--primary)">{{ boarded_students|length }}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Assigned Students</div>
                    <div class="stat-value">{{ assigned_students|length }}</div>
                </div>
            </div>

            <div class="detail-grid">
                <div class="info-group">
                    <label for="input-model">Model</label>

                    <input type="text" id="input-model" class="form-input-edit" value="{{ bus.model or '' }}">
                </div>
                <div class="info-group">
                    <label for="input-route">Route</label>

                    <select id="input-route" class="form-input" style="display:block;"
                        onchange="updateLiveAssignment('route', this)">
                        <option value="">N/A</option>
                        {% for route in routes %}
                        <option value="{{ route.route_name }}" data-id="{{ route.id }}" {% if
                            bus.route==route.route_name %}selected{% endif %}>{{ route.route_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="info-group">
                    <label for="input-driver">Driver</label>

                    <select id="input-driver" class="form-input" style="display:block;"
                        onchange="updateLiveAssignment('driver', this)">
                        <option value="">Unassigned</option>
                        {% for driver in drivers %}
                        <option value="{{ driver.id }}" data-name="{{ driver.full_name }}" {% if
                            bus.driver_name==driver.full_name %}selected{% endif %}>{{ driver.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--glass-border);">
                <h4
                    style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:12px; text-transform:uppercase;">
                    Maintenance & Compliance</h4>
                <div class="detail-grid">
                    <div class="info-group">
                        <label for="input-last-service">Last Service</label>
                        <div class="value" id="display-last-service">{{ bus.last_service_date or 'N/A' }}</div>
                        <input type="date" id="input-last-service" class="form-input-edit"
                            value="{{ bus.last_service_date or '' }}">
                    </div>
                    <div class="info-group">
                        <label for="input-next-service">Next Due</label>
                        <div class="value" id="display-next-service">{{ bus.next_service_due or 'N/A' }}</div>
                        <input type="date" id="input-next-service" class="form-input-edit"
                            value="{{ bus.next_service_due or '' }}">
                    </div>
                    <div class="info-group">
                        <label for="input-insurance">Insurance Exp</label>
                        <div class="value" id="display-insurance">{{ bus.insurance_expiry or 'N/A' }}</div>
                        <input type="date" id="input-insurance" class="form-input-edit"
                            value="{{ bus.insurance_expiry or '' }}">
                    </div>
                    <div class="info-group">
                        <label for="input-fitness">Fitness Exp</label>
                        <div class="value" id="display-fitness">{{ bus.fitness_expiry or 'N/A' }}</div>
                        <input type="date" id="input-fitness" class="form-input-edit"
                            value="{{ bus.fitness_expiry or '' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Map -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="section-title">Live Tracking</div>
            <div id="single-bus-map"></div>
        </div>

        <!-- Boarded Students -->
        <div class="modern-card" style="margin-bottom: 24px;">
            <div class="section-title">Current Boarded Students</div>
            {% if boarded_students %}
            <div style="overflow-x: auto;" class="table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Roll No</th>
                            <th>Parent Phone</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in boarded_students %}
                        <tr>
                            <td>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    {% if student.profile_photo_url %}
                                    <img src="{{ student.profile_photo_url }}" alt="{{ student.full_name }}"
                                        title="{{ student.full_name }}"
                                        style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                                    {% else %}
                                    <div
                                        style="width:32px; height:32px; border-radius:50%; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center;">
                                        üë§</div>
                                    {% endif %}
                                    <span style="font-weight:500;">{{ student.full_name }}</span>
                                </div>
                            </td>
                            <td>{{ student.roll_number }}</td>
                            <td>{{ student.parent_phone or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">No students
                currently
                boarded.</div>
            {% endif %}
        </div>

        <!-- Trip History -->
        <div class="modern-card" style="margin-bottom: 24px;">
            <div class="section-title">
                <span>Recent Trips</span>
                <a href="{{ url_for('buses.bus_trip_history', bus_id=bus.id) }}"
                    style="font-size:0.85rem; color:var(--primary); text-decoration:none;">View All ‚Üí</a>
            </div>
            <div style="overflow-x: auto;" class="table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Students</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trip in trip_history %}
                        <tr>
                            <td>{{ trip.date }}</td>
                            <td>
                                {{ trip.startTime[11:16] if trip.startTime|length > 16 else trip.startTime }}
                                -
                                {{ trip.endTime[11:16] if trip.endTime and trip.endTime|length > 16 else (trip.endTime
                                or '-') }}
                            </td>
                            <td>{{ trip.type|capitalize }}</td>
                            <td>{{ trip.boardedStudents }} / {{ trip.totalStudents }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center; color:var(--text-muted);">No trip history found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Assigned Students -->
        <div class="card">
            <div class="section-title">Assigned Students</div>
            {% if assigned_students %}
            <div style="overflow-x: auto;" class="table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Roll No</th>
                            <th>Class</th>
                            <th>Stop</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in assigned_students %}
                        <tr style="cursor:pointer;" class="clickable-row"
                            data-href="{{ url_for('students.student_details', student_id=student.id) }}">
                            <td>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    {% if student.profile_photo_url %}
                                    <img src="{{ student.profile_photo_url }}" alt="{{ student.full_name }}"
                                        title="{{ student.full_name }}"
                                        style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                                    {% else %}
                                    <div
                                        style="width:32px; height:32px; border-radius:50%; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center;">
                                        üë§</div>
                                    {% endif %}
                                    <span style="font-weight:500;">{{ student.full_name }}</span>
                                </div>
                            </td>
                            <td>{{ student.roll_number }}</td>
                            <td>{{ student.batch or '-' }}</td>
                            <td>{{ student.bus_stop or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align:center; padding:20px; color:var(--text-muted); font-style:italic;">No students
                assigned to this
                bus.</div>
            {% endif %}
        </div>





    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('single-bus-map')) {
            const map = L.map('single-bus-map').setView([12.096, 75.558], 14); // Default center (Chemperi)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const uid = "{{ session['uid'] }}";
            const busId = "{{ bus.id }}";
            const busNo = "{{ bus.bus_number }}";
            let marker = null;

            // Custom Bus Icon
            const busIcon = L.divIcon({
                html: '<div style="font-size: 24px; line-height: 1; text-shadow: 0 0 5px rgba(0,0,0,0.5);">üöå</div>',
                className: 'bus-marker-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });

            const busRef = rtdb.ref(`organizations/${uid}/bus_location/${busId}`);
            console.log(`[DEBUG] Listening to RTDB path: organizations/${uid}/bus_location/${busId}`);

            busRef.on('value', (snapshot) => {
                const data = snapshot.val();
                console.log("[DEBUG] Received data:", data);

                if (data && data.latitude != null && data.longitude != null) {
                    const lat = parseFloat(data.latitude);
                    const lng = parseFloat(data.longitude);

                    if (isNaN(lat) || isNaN(lng)) {
                        console.error("[DEBUG] Invalid coordinates:", lat, lng);
                        return;
                    }

                    if (marker) {
                        marker.setLatLng([lat, lng]);
                        marker.setPopupContent(`<b>Bus ${busNo}</b><br>Speed: ${data.speed} km/h`);
                    } else {
                        marker = L.marker([lat, lng], { icon: busIcon }).addTo(map)
                            .bindPopup(`<b>Bus ${busNo}</b><br>Speed: ${data.speed} km/h`)
                            .openPopup();
                    }
                    map.setView([lat, lng], 14); // Auto-center
                } else {
                    console.warn("[DEBUG] Data missing latitude/longitude or is null. Data:", data);
                }
            }, (error) => {
                console.error("Error fetching bus location:", error);
            });

        }
    });

    let isEditing = false;

    function toggleEditMode() {
        if (isEditing) {
            saveChanges();
        } else {
            isEditing = true;
            document.getElementById('editBtn').innerHTML = '<span style="font-size:1rem; margin-right:6px">üíæ</span> Save Changes';
            // Use classes instead of inline styles
            document.getElementById('editBtn').classList.remove('btn-primary');
            document.getElementById('editBtn').style.background = '#69F0AE'; // Success color manually or class
            document.getElementById('editBtn').style.color = '#000';

            // Show inputs, hide displays
            const fields = ['capacity', 'model', 'driver', 'route', 'last-service', 'next-service', 'insurance', 'fitness'];
            fields.forEach(field => {
                const displayEl = document.getElementById(`display-${field}`);
                const inputEl = document.getElementById(`input-${field}`);
                if (displayEl && inputEl) {
                    displayEl.style.display = 'none';
                    if (field === 'model' || field === 'capacity') {
                        inputEl.style.display = 'block'; // Or whatever display property they had
                    } else {
                        inputEl.style.display = 'block';
                    }
                    inputEl.style.display = 'block';
                }
            });
        }
    }

    function saveChanges() {
        const btn = document.getElementById('editBtn');
        const originalText = '<span style="margin-right:8px">‚úèÔ∏è</span> Edit Bus';
        btn.disabled = true;
        btn.innerText = 'Saving...';

        const driverSelect = document.getElementById('input-driver');
        const selectedOption = driverSelect.options[driverSelect.selectedIndex];
        const driverId = driverSelect.value;
        const driverName = selectedOption.getAttribute('data-name') || (driverId === '' ? 'Unassigned' : selectedOption.innerText);

        const data = {
            capacity: document.getElementById('input-capacity').value,
            model: document.getElementById('input-model').value,
            driver_name: driverName,
            driver_id: driverId === '' ? null : driverId,
            route: document.getElementById('input-route').value,
            route_id: document.getElementById('input-route').options[document.getElementById('input-route').selectedIndex].getAttribute('data-id') || '',
            last_service_date: document.getElementById('input-last-service').value,
            next_service_due: document.getElementById('input-next-service').value,
            insurance_expiry: document.getElementById('input-insurance').value,
            fitness_expiry: document.getElementById('input-fitness').value
        };
        fetch("{{ url_for('api.api_update_bus', bus_id=bus.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Bus details updated successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = ''; // Reset to class style
                    btn.style.color = '';
                    btn.classList.add('btn-primary');
                    isEditing = false;
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.backgroundColor = '';
                btn.style.color = '';
                btn.classList.add('btn-primary');
                isEditing = false;
            });
    }
    // Handle clickable rows
    document.addEventListener('DOMContentLoaded', () => {
        const rows = document.querySelectorAll('.clickable-row');
        rows.forEach(row => {
            row.addEventListener('click', () => {
                if (row.dataset.href) {
                    window.location.href = row.dataset.href;
                }
            });
        });
    });

    function updateLiveAssignment(type, element) {
        const payload = {};

        if (type === 'route') {
            const selectedOption = element.options[element.selectedIndex];
            payload.route = element.value;
            payload.route_id = selectedOption.getAttribute('data-id') || '';
        } else if (type === 'driver') {
            const selectedOption = element.options[element.selectedIndex];
            payload.driver_id = element.value || null;
            payload.driver_name = selectedOption.getAttribute('data-name') || (element.value ? selectedOption.innerText : 'Unassigned');
        }

        // Visual feedback
        const originalBg = element.style.backgroundColor;
        element.style.backgroundColor = '#e0f2fe'; // Light blue indicating processing

        fetch("{{ url_for('api.api_update_bus', bus_id=bus.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    element.style.backgroundColor = '#dcfce7'; // Light green success
                    setTimeout(() => {
                        element.style.backgroundColor = originalBg || '';
                        if (type === 'driver') window.location.reload(); // Reload to update sidebar driver info
                    }, 500);
                } else {
                    alert('Error updating ' + type + ': ' + data.message);
                    element.style.backgroundColor = '#fee2e2'; // Light red error
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update. Check connection.');
                element.style.backgroundColor = '#fee2e2';
            });
    }
</script>
{% endblock %}