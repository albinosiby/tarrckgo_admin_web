{% extends "base.html" %}

{% set active_page = 'tracking' %}

{% block title %}Smart Bus Admin Panel - Live Tracking{% endblock %}

{% block header_title %}Smart Bus Admin â€¢ Live Tracking{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    #map {
        height: calc(100vh - 100px);
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Override content padding for full screen map if needed, but base.html has padding. 
     If we want full screen map, we might need to override main.content style or live with padding.
     In original tracking.html: <main class="content" style="padding:0; overflow:hidden">
     I can't easily override the class attribute of the block parent. 
     But I can add a style block to override .content for this page? 
     Or just accept the padding. The original had specific style.
-->
<style>
    /* Scoped style to remove padding from content area for this page only if possible, 
       but since this is globally applied, it might be tricky. 
       However, we can just put the map inside the block. 
       If I want to match original exactly (padding:0), I might need to add a block to base.html for 'content_class' or similar.
       For now, I will just put the map. The padding might look okay. 
       Actually, let's try to override it via css in head block.
    */
    .content {
        padding: 0 !important;
        overflow: hidden !important;
    }
</style>
<div id="map"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const map = L.map('map').setView([12.096, 75.558], 14); // Default center (Chemperi)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markers = {};
        const uid = "{{ session['uid'] }}"; // Get Organization ID

        // Listen to all buses in the organization
        const locationRef = rtdb.ref(`organizations/${uid}/bus_location`);

        locationRef.on('value', (snapshot) => {
            const buses = snapshot.val();
            console.log("[DEBUG Tracker] Received buses data:", buses);
            if (buses) {
                // Clear markers not in data anymore (optional, handled by update)

                Object.keys(buses).forEach(busId => {
                    const data = buses[busId];
                    if (data && data.latitude != null && data.longitude != null) {
                        const lat = parseFloat(data.latitude);
                        const lng = parseFloat(data.longitude);

                        if (isNaN(lat) || isNaN(lng)) return;

                        // Update or Create Marker
                        if (markers[busId]) {
                            markers[busId].setLatLng([lat, lng]);
                            markers[busId].setPopupContent(`<b>Bus ${data.bus_number}</b><br>Speed: ${data.speed} km/h`);
                        } else {
                            const marker = L.marker([lat, lng]).addTo(map)
                                .bindPopup(`<b>Bus ${data.bus_number}</b><br>Speed: ${data.speed} km/h`);
                            markers[busId] = marker;

                            // Auto-center on first bus found if map not moved yet? 
                            // Or leave it valid.
                        }
                    }
                });
            }
        }, (error) => {
            console.error("Error fetching bus locations:", error);
        });
    });
</script>
{% endblock %}